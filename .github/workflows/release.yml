name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # Run tests before releasing
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

  # Build Python package (wheel + sdist)
  build-package:
    name: Build Python package
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build wheel and sdist
        run: |
          python -m build

      - name: Check package with twine
        run: |
          twine check dist/*

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/

  # Build desktop apps for all platforms
  build-desktop-macos:
    name: Build desktop app (macOS)
    runs-on: macos-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[build]

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-macos-${{ github.ref_name }}
          path: dist/DAiW.app/

  build-desktop-linux:
    name: Build desktop app (Linux)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0 gir1.2-webkit2-4.1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[build]

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-linux-${{ github.ref_name }}
          path: dist/DAiW/

  build-desktop-windows:
    name: Build desktop app (Windows)
    runs-on: windows-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[build]

      - name: Build DAiW app with PyInstaller
        run: |
          pyinstaller daiw.spec --clean --noconfirm

      - name: Upload built app (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: DAiW-windows-${{ github.ref_name }}
          path: dist/DAiW/

  # Create GitHub Release with all artifacts
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-package, build-desktop-macos, build-desktop-linux, build-desktop-windows]
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/python-package/*
          body: |
            ## DAiW Music Brain ${{ github.ref_name }}

            ### Installation
            ```bash
            pip install daiw
            ```

            ### Desktop Apps
            Download the appropriate desktop app for your platform from the artifacts.
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

  # Optional: Publish to TestPyPI (uncomment when ready)
  # publish-testpypi:
  #   name: Publish to TestPyPI
  #   runs-on: ubuntu-latest
  #   needs: build-package
  #   environment: testpypi
  #
  #   steps:
  #     - name: Download package artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: python-package
  #         path: dist/
  #
  #     - name: Publish to TestPyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       with:
  #         repository-url: https://test.pypi.org/legacy/
